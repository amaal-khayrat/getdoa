name: Manual Deploy to EC2

on:
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      tanstack_changed: ${{ steps.filter.outputs.tanstack }}
      compose_changed: ${{ steps.filter.outputs.compose }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get base commit (previous deploy or 24 hours ago)
        id: get-base-commit
        run: |
          # Get timestamp from 24 hours ago
          TIMESTAMP=$(date -d "24 hours ago" +%s)
          # Find the nearest commit before that timestamp on the current branch
          BASE_COMMIT=$(git log --before=@$TIMESTAMP -n 1 --format=%H)
          if [ -z "$BASE_COMMIT" ]; then
            echo "No base commit found, using initial commit"
            BASE_COMMIT=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "base_commit=$BASE_COMMIT" >> $GITHUB_OUTPUT
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          base: "${{ steps.get-base-commit.outputs.base_commit }}"
          filters: |
            tanstack:
              - 'tanstack/**/*.ts'
              - 'tanstack/**/*.tsx'
              - 'tanstack/**/*.js'
              - 'tanstack/**/*.jsx'
            compose:
              - 'docker-compose.yml'

  deploy:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.tanstack_changed == 'true' ||
      needs.detect-changes.outputs.compose_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_INSTANCE_SG_ID: ${{ secrets.AWS_INSTANCE_SG_ID }} # security group id for EC2 instance

    steps:
      - name: Check out code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Full history for consistency with detect-changes

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::254718381590:role/getdoa
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get runner IP address
        id: ip
        uses: haythem/public-ip@v1.2

      - name: Whitelist runner IP address
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id $AWS_INSTANCE_SG_ID \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32

      - name: Create .ssh directory and SSH key file
        run: |
          mkdir -p /home/runner/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > /home/runner/.ssh/ec2_key
          chmod 600 /home/runner/.ssh/ec2_key

      - name: Create getdoa directory on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i /home/runner/.ssh/ec2_key ubuntu@43.217.8.220 "if [ ! -d '/home/ubuntu/getdoa' ]; then mkdir -p /home/ubuntu/getdoa; fi"

      - name: Transfer docker-compose.yml to EC2
        run: |
          scp -o StrictHostKeyChecking=no -i /home/runner/.ssh/ec2_key \
            ./docker-compose.yml ubuntu@43.217.8.220:/home/ubuntu/getdoa/docker-compose.yml

      - name: Deploy TanStack application
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: 43.217.8.220
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Create getdoa directory if it doesn't exist
            mkdir -p /home/ubuntu/getdoa

            # Fix ownership of docker-compose.yml
            sudo chown ubuntu:ubuntu /home/ubuntu/getdoa/docker-compose.yml

            # Update .env file with required secrets
            echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" > /home/ubuntu/getdoa/.env
            echo "BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}" >> /home/ubuntu/getdoa/.env
            echo "BETTER_AUTH_URL=${{ secrets.BETTER_AUTH_URL }}" >> /home/ubuntu/getdoa/.env
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> /home/ubuntu/getdoa/.env
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> /home/ubuntu/getdoa/.env
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> /home/ubuntu/getdoa/.env
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> /home/ubuntu/getdoa/.env
            echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> /home/ubuntu/getdoa/.env
            echo "ADMIN_EMAILS=${{ secrets.ADMIN_EMAILS }}" >> /home/ubuntu/getdoa/.env

            # Clean up any Docker resources to prevent image corruption issues
            sudo docker system prune -f --volumes

            # Deploy TanStack application
            if [ "${{ needs.detect-changes.outputs.compose_changed }}" == "true" ]; then
              # If docker-compose.yml changed, pull and restart all services
              sudo docker compose -f /home/ubuntu/getdoa/docker-compose.yml --env-file /home/ubuntu/getdoa/.env pull
              sudo docker compose -f /home/ubuntu/getdoa/docker-compose.yml --env-file /home/ubuntu/getdoa/.env up -d --remove-orphans
            elif [ "${{ needs.detect-changes.outputs.tanstack_changed }}" == "true" ]; then
              # If only tanstack code changed, restart only tanstack service
              sudo docker compose -f /home/ubuntu/getdoa/docker-compose.yml --env-file /home/ubuntu/getdoa/.env pull tanstack
              sudo docker compose -f /home/ubuntu/getdoa/docker-compose.yml --env-file /home/ubuntu/getdoa/.env up -d --remove-orphans tanstack
            fi

      - name: Revoke runner IP address
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id $AWS_INSTANCE_SG_ID \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32
